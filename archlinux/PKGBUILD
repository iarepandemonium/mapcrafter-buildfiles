# Maintainer: Moritz Hilscher <m0r13@mapcrafter.org>

pkgname=mapcrafter-git
pkgver=v.1.5.1.r10.gba5994a
pkgrel=1
pkgdesc="A High Performance Minecraft Map Renderer"
arch=("i686" "x86_64")
license=("GPL")
url="http://mapcrafter.org"
makedepends=("cmake" "boost" "imagemagick")
depends=("boost-libs" "libpng" "libjpeg" "curl" "python2")
optdepends=(
    "python2-pillow: support for mapcrafter_png-it.py script"
)
source=("$pkgname"::"git://github.com/mapcrafter/mapcrafter.git")
md5sums=("SKIP")

pkgver() {
    cd "$srcdir/$pkgname"
    git describe --long | sed -E 's/([^-]*-g)/r\1/;s/-/./g'    
}

build() {
    cd "$srcdir/$pkgname"
    cmake -DCMAKE_INSTALL_PREFIX="$pkgdir/usr" .
    make
}

package() {
    cd "$srcdir/$pkgname"
    VERBOSE=1 make install

    curl --output /tmp/mc.jar https://s3.amazonaws.com/Minecraft.Download/versions/1.8/1.8.jar
    python2 "$srcdir/$pkgname/src/tools/mapcrafter_textures.py" -f /tmp/mc.jar "$pkgdir/usr/share/mapcrafter/textures"

    # Fix "known incorrect sRGB profile" warning
    convert $pkgdir/usr/share/mapcrafter/textures/blocks/glass_pane_top_white.png -type TrueColorMatte -define png:color-type=6 $pkgdir/usr/share/mapcrafter/textures/blocks/glass_pane_top_white.png
    for i in \
      hardened_clay.png \
      hardened_clay_stained_black.png \
      hardened_clay_stained_blue.png \
      hardened_clay_stained_brown.png \
      hardened_clay_stained_cyan.png \
      hardened_clay_stained_gray.png \
      hardened_clay_stained_green.png \
      hardened_clay_stained_light_blue.png \
      hardened_clay_stained_lime.png \
      hardened_clay_stained_magenta.png \
      hardened_clay_stained_orange.png \
      hardened_clay_stained_pink.png \
      hardened_clay_stained_purple.png \
      hardened_clay_stained_red.png \
      hardened_clay_stained_silver.png \
      hardened_clay_stained_white.png \
      hardened_clay_stained_yellow.png \
      red_sand.png;
    do
        convert $pkgdir/usr/share/mapcrafter/textures/blocks/$i $pkgdir/usr/share/mapcrafter/textures/blocks/$i;
    done
}
